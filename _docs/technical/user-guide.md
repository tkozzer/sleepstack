# USER GUIDE — Binaural + Ambience Pipeline (with narration tips)

**Quick start:** `uv run sleepstack --vibe calm -a campfire -m 5` (headphones required).

**Verify output:** Open the mixed file and confirm it's stereo and audible under headphones.

## Installation Options

### Option 1: Run directly with uv (recommended for development)
```bash
uv run sleepstack --help
uv run sleepstack --list-vibes
```

### Option 2: Install globally
```bash
uv tool install .
sleepstack --help
```

### Option 3: Install in a virtual environment
```bash
uv sync
uv run sleepstack --help
```

1. What this setup does
      - Generates a binaural beat track from plain-English "vibes" (calm, deep, etc.).
      - Auto-mixes it with ambience (e.g., campfire) to the exact length you ask for.
      - Saves finished files into your `build/` directory so you can drop them under narration in GarageBand (or your DAW).

2. Prerequisites
   - Python 3.11+ with `uv` package manager
   - Install dependencies:

```bash
uv sync
```

   - The package is structured as `src/sleepstack/` with CLI entry point.
   - Ambience clips are at: `assets/ambience/campfire/campfire_1m.wav` (1-minute clip with automatic looping).
   - Keep sample rate consistent (**48 kHz** for everything). **Stereo headphones required** (don't downmix).
   - All example commands assume your files are in the shown folders; if not, use `--out` / `--binaural-out` to set paths.

3. Directory expectations (already matching your repo)
   - Binaural outputs land in: `build/binaural/`
   - Mixed outputs (binaural + ambience) land in: `build/mix/`
   - You can override output locations with the `--out` flag when needed.

4. The one-command workflow (recommended)
   - Run one command to generate and mix.

Examples

```bash
uv run sleepstack --vibe calm -a campfire -m 5
```

Or with custom output:
```bash
uv run sleepstack --vibe calm -a campfire -m 5 --out build/mix/calm_5m__campfire.wav
```

This will:
   - Create a 5-minute calm binaural bed (6 Hz at 200 Hz).
   - Use the 1-minute campfire clip with automatic looping to match 5 minutes.
   - Mix them at comfortable defaults (binaural -15 dB, ambience -21 dB, ambience has 2s fades).
   - Save to `build/mix/` with a sensible filename.

5. Required arguments for `sleepstack`
   - You must include **--vibe + one duration + one ambience source**.
   - `--vibe <name>`  (e.g., calm, deep, soothe, meditate, airy, warm, focus, flow, alert)
   - One duration: `--minutes N` (or `-m`) OR `--seconds N` (or `-s`)
     - **Maximum duration**: 10 minutes (600 seconds) per track
     - **Minimum duration**: Any value > 0
   - One ambience source:
     - `--ambient campfire` (uses 1-minute campfire clip with automatic looping)
     - OR `--ambience-file path/to/ambient.wav` (explicit file; mono is okay; it will be duplicated to L/R)

### New CLI Features
- `--version`: Show package version
- `--list-vibes`: Display all available vibe presets and aliases
- `--verbose` / `-v`: Enable detailed output
- `--quiet` / `-q`: Suppress non-error output
- **Multi-ambient support**: Use comma-separated lists for multiple ambient sounds (e.g., `-a campfire,rain,ocean`)
- **Ambient sound management**: Download, list, and remove ambient sounds from YouTube

Example with explicit ambience file:
```bash
uv run sleepstack --vibe calm --ambience-file assets/ambience/campfire/campfire_1m.wav -m 5
```

6. Useful optional arguments (`sleepstack`)
   - Binaural generation (overrides preset): `--beat`, `--carrier`, `--samplerate`, `--volume`, `--fade`, `--loop`
   - Paths: `--binaural-out` (raw binaural location), `--out` (final mixed location)
   - Mix levels: `--binaural-db` (default -15), `--ambience-db` (default -21), **`--ambience-fade`** (default 2.0)

Example with custom paths:
```bash
uv run sleepstack --vibe calm -a campfire -m 5 --binaural-out build/binaural/calm_5m_raw.wav
uv run sleepstack --vibe calm -a campfire -m 5 --out build/mix/my_custom_name.wav
```

Tip: If you want a seamless loop bed, add `--loop` (sets binaural fade to 0). For single-play, leave fade at 2s.

7. Typical recipes
   - Sleep-ready meta-core install (deeper settle):

```bash
uv run sleepstack --vibe deep -a campfire -m 5
```

   - Balanced under-narration default (most common):

```bash
uv run sleepstack --vibe calm -a campfire -m 5
```

   - Awake practice (not for sleep):

```bash
uv run sleepstack --vibe focus -a campfire -m 5
```

8. Where the files end up
   - Raw binaural: `build/binaural/<auto-generated name>.wav` (unless you set `--binaural-out`)
   - Final mixed: `build/mix/<binaural_basename>__<ambience_name>.wav` (unless you set `--out`)
   - **File naming pattern:** `binaural__ambience.wav` (e.g., `meta_core_theta6_5min__campfire.wav`) so you can easily identify what's what in Finder.

9. How to place under narration (GarageBand/DAW)
   - Import your mixed bed (binaural + ambience) as one stereo track.
   - Narration: import your voice as a separate mono track.
   - Keep the bed low: binaural around -15 dB; ambience 3–6 dB below the binaural if you tweak manually.
   - Gentle processing on narration only: high-pass ~80 Hz, light compression (2:1), peak normalize to around -1 dBFS on export.
   - If your DAW exports quietly, turn off any 'loudness normalization' and set export to 48 kHz, 24-bit or 16-bit PCM.
   - Don't downmix the bed to mono — binaural needs stereo headphones.

10. Best-fit vibe recommendations for narration (bedtime scripts)
   - Top defaults (under spoken word):
     - `calm` (6.0 Hz @ 200 Hz): balanced, steady theta; the safest first pick.
     - `soothe` (5.0 Hz @ 190 Hz): slightly sleepier than calm; very soft under slow narration.
     - `meditate` (5.5 Hz @ 200 Hz): mild alertness while staying gentle and steady.
   - If your voice is deep/baritone:
     - `airy` (6.0 Hz @ 260 Hz) so the carrier sits above vocal fundamentals; reduces masking.
   - If you want heavier drift toward sleep:
     - `deep` (4.5 Hz @ 180 Hz) but front-load your key lines; you may get drowsy before you finish.
   - Avoid for bedtime narration:
     - `alert`/`flow`/`focus` (≥ 6.5–8 Hz): better for daytime pep or editing sessions; a bit perky for falling asleep mid-script.

11. Level & balance cheat-sheet
   - Bed vs. voice: if you can whisper over the bed comfortably, you're in the right zone.
   - Voice should **peak -1 dBFS** on export; bed should never clip.
   - Binaural: target about -15 dB relative to full scale; ambience ~3–6 dB lower than the binaural.
   - If the bed fights your voice:
     - For deep voices, move to `airy` (carrier 260 Hz) or raise carrier to 220–260 Hz.
     - For higher voices, `calm`/`soothe`/`meditate` at 180–200 Hz carriers sit well.

12. Troubleshooting
   - **Headphones only**: binaural beats don't work on laptop speakers; you need stereo headphones.
   - **Duration limits**: Maximum 10 minutes per track. If you get "must be <= 10 minutes" or "must be <= 600 seconds", reduce your duration.
   - If ambience is mono, the mixer duplicates it to L/R—this is expected.
   - If you get 'file not found' for campfire clips, confirm `campfire_1m.wav` exists at `assets/ambience/campfire/` and is a 48 kHz WAV.
   - "Sample rate mismatch" error: regenerate or resample so both files match (recommend 48000 Hz).
   - "Binaural must be stereo": ensure you generated the bed with `sleepstack` and haven't converted it to mono.
   - The mix feels boomy: reduce ambience level by 2–4 dB or use a gentle low-shelf/HPF on ambience in your DAW.
   - If the bed fights your voice, try **airy** first or raise **carrier** 20–40 Hz.
   - If the mix is silent, check your output levels: try `--binaural-db -12 --ambience-db -18`.
   - Too sleepy too soon: bump vibe from deep → soothe or calm, or shorten your script to get essentials in the first 90 seconds.
   - Not sleepy enough: drop to `soothe` or `deep`, or lower beat from 6 Hz toward 4.5–5 Hz.

13. Suggested first builds (1-minute taste tests before committing)
   - Calm under narration:

```bash
uv run sleepstack --vibe calm -a campfire -m 1
```

   - Airy for deep voices:

```bash
uv run sleepstack --vibe airy -a campfire -m 1
```

   - Soothe for softer cadence:

```bash
uv run sleepstack --vibe soothe -a campfire -m 1
```

   - Quick 90-second test:

```bash
uv run sleepstack --vibe calm -a campfire -s 90
```

   - Maximum duration test (10 minutes):

```bash
uv run sleepstack --vibe calm -a campfire -m 10
uv run sleepstack --vibe deep -a campfire -s 600
```

14. Workflow tip for versioning
   - Keep a short notes file next to your tracks listing date, vibe, beat/carrier, levels, and whether it "felt right" under your current script. It makes dialing in the next iteration trivial.

That's it — use `calm` as your default under narration, `airy` if your voice is deep, and `deep` only when you intentionally want to drift after the key lines.

## Ambient Sound Management

SleepStack now supports downloading ambient sounds from YouTube and managing multiple ambient sounds per track.

### Prerequisites for Ambient Sound Downloads

Before downloading ambient sounds, you need to install system dependencies:

**macOS (using Homebrew):**
```bash
brew install ffmpeg
```

**Ubuntu/Debian:**
```bash
sudo apt update
sudo apt install ffmpeg
```

**Windows:**
- Download ffmpeg from https://ffmpeg.org/download.html
- Add to your system PATH

The `yt-dlp` package is automatically installed with SleepStack.

### Downloading Ambient Sounds

Use the `download-ambient` subcommand to download sounds from YouTube:

```bash
# Download a rain sound
uv run sleepstack download-ambient "https://www.youtube.com/watch?v=example" rain

# Download with description
uv run sleepstack download-ambient "https://youtu.be/example" ocean --description "Ocean waves"

# Download thunderstorm sounds
uv run sleepstack download-ambient "https://www.youtube.com/watch?v=example" thunder --description "Thunderstorm sounds"
```

**What happens during download:**
- Audio is extracted from the YouTube video
- Converted to 48kHz stereo WAV format
- Trimmed to 1 minute starting at 60 seconds (to skip intros/ads)
- Saved to `assets/ambience/<name>/<name>_1m.wav`
- Metadata is stored for future reference

### Listing Available Ambient Sounds

```bash
# List all available sounds
uv run sleepstack list-ambient

# Show detailed information
uv run sleepstack list-ambient --detailed
```

### Using Multiple Ambient Sounds

You can now mix multiple ambient sounds in a single track:

```bash
# Mix campfire and rain
uv run sleepstack --vibe calm -a campfire,rain -m 5

# Mix three ambient sounds
uv run sleepstack --vibe deep -a campfire,rain,thunder -m 10

# Mix with custom volume levels
uv run sleepstack --vibe soothe -a campfire,ocean -m 5 --ambience-db -18
```

**Volume mixing:**
- Each ambient sound is mixed at the same level by default
- Use `--ambience-db` to control the overall ambient level
- Individual volume control per sound is planned for future releases

### Removing Ambient Sounds

```bash
# Remove an ambient sound (with confirmation)
uv run sleepstack remove-ambient rain

# Remove without confirmation
uv run sleepstack remove-ambient thunder --force
```

**What gets removed:**
- The ambient sound directory and all files
- Metadata and references
- Any mixed tracks that used this sound (you'll need to regenerate them)

### Configuration and State Management

SleepStack includes comprehensive configuration and state management:

```bash
# Show current configuration
uv run sleepstack config show

# Set configuration values
uv run sleepstack config set download.sample_rate 48000
uv run sleepstack config set processing.volume_adjustment 0.8

# Show download history
uv run sleepstack config history

# Show application state
uv run sleepstack state show

# Check asset health
uv run sleepstack state health

# Clean up old maintenance records
uv run sleepstack state cleanup
```

### Troubleshooting Ambient Sound Issues

**Download fails:**
- Verify ffmpeg is installed: `ffmpeg -version`
- Check YouTube URL is valid and accessible
- Ensure video is longer than 2 minutes (needs 60s + 1m content)
- Try a different video if the current one has restrictions

**Audio quality issues:**
- Downloaded audio is automatically converted to 48kHz stereo
- If source audio is poor quality, try a different video
- Check file size - very small files may indicate low quality

**Missing ambient sounds:**
- Use `sleepstack list-ambient` to see available sounds
- Check `assets/ambience/` directory structure
- Re-download if files are corrupted or missing

**Mixing issues:**
- Ensure all ambient sounds are 48kHz WAV format
- Check file permissions in `assets/ambience/` directory
- Use `--verbose` flag to see detailed processing information

**Performance with multiple sounds:**
- More ambient sounds = longer processing time
- Large numbers of sounds (>5) may impact memory usage
- Consider using fewer, higher-quality sounds for better results
