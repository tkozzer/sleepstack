---
title: UV Package Restructure Checklist
description: Migrate from standalone scripts to uv packaged application with proper src/ layout, build backend, and console scripts
---

This checklist follows `103-docs-checklist` — keep it updated as tasks complete. Reference real files using backticks.

# Dependencies

- Build-time
  - uv add -G dev pytest black mypy
- Runtime
  - uv add numpy
  - uv add soundfile (only if resampling is needed)
  - If replacing argparse with Click, add: uv add click

# Goal & KPIs

**Goal**: Restructure the project as a proper Python package using `uv`'s packaged application template with `src/` layout, build backend, and console scripts.

**Success Metrics**:
- [x] `uv run sleepstack` works as a first-class CLI command
- [x] `uv tool install .` works and `sleepstack` runs globally
- [x] Build sdist/wheel succeeds (`uv build`)
- [x] All existing functionality preserved (binaural generation, mixing, vibe presets)
- [x] Clean `src/sleepstack/` package structure
- [x] Proper `pyproject.toml` with `[project.scripts]` entry point
- [x] Assets organized outside package (`assets/` and `build/` directories)
- [x] Reproducible installs with `uv.lock`
- [x] GitHub Actions CI passes on main (Linux + macOS)
  - [x] CI workflow created and committed
  - [x] Tests on Ubuntu and macOS with Python 3.11 and 3.12
  - [x] Comprehensive testing including CLI smoke tests and package building

# Project Structure Setup

- [x] Create new packaged app skeleton
  - [x] Run `uv init --package sleepstack` in clean directory
  - [x] Verify generated structure: `pyproject.toml`, `src/sleepstack/__init__.py`
- [x] Set up proper directory structure
  - [x] Create `assets/ambience/campfire/` directory
  - [x] Create `build/binaural/` and `build/mix/` directories
  - [x] Move existing `sounds/` content to `assets/`
- [x] Update `.gitignore`
  - [x] Ignore `.venv/`, `build/`, `__pycache__/`, OS/editor junk
  - [x] Include editor cruft: `.DS_Store`, `Thumbs.db`, and DAW caches (`*.band`, `*.logicx`, etc.)
  - [x] **Commit** `pyproject.toml` and `uv.lock`
    - [x] Committed package configuration and lock file

# Code Migration

- [x] Move Python modules to `src/sleepstack/`
  - [x] Move `main.py` → `src/sleepstack/main.py`
  - [x] Move `make_binaural.py` → `src/sleepstack/make_binaural.py`
  - [x] Move `mix_binaural_with_ambience.py` → `src/sleepstack/mix_binaural_with_ambience.py`
  - [x] Move `vibe_binaural.py` → `src/sleepstack/vibe_binaural.py`
- [x] Create a single orchestrator: `src/sleepstack/main.py` exports `run(argv: list[str] | None = None) -> int`
- [x] Create CLI entry point
  - [x] Create `src/sleepstack/cli.py` with `main()` function (only module touching argparse/Click)
  - [x] `src/sleepstack/cli.py` parses args and calls `from .main import run; raise SystemExit(run())`
  - [x] Add standard CLI flags: `--version`, `--list-vibes`, `--verbose/--quiet`
  - [x] Decide exit codes: return `0` on success, non-zero on known errors
  - [x] Add proper argument parsing and help text
- [x] Update import paths
  - [x] Fix relative imports between modules in `src/sleepstack/`
  - [x] Update asset path references to use `assets/` instead of `sounds/`
  - [x] Update output paths to use `build/` directories

# Package Configuration

- [x] Configure `pyproject.toml`
  - [x] Set project metadata (name, version, description, license, authors)
  - [x] **Use the build backend generated by `uv init --package`** (do not override)
  - [x] Add `[project.scripts]` entry: `sleepstack = "sleepstack.cli:main"`
  - [x] Add runtime dependencies (`numpy` [and `soundfile` **only if used**])
  - [x] Add `[project.optional-dependencies]` groups for `dev` (pytest/black/mypy)
  - [x] Add dev dependency configs under `[tool.black]`, `[tool.mypy]`, `[tool.pytest.ini_options]`
- [x] Add dependencies with uv
  - [x] Run `uv add numpy` for runtime deps
  - [x] Run `uv add soundfile` only if resampling is needed
  - [x] Run `uv add --dev pytest black mypy` for dev deps
  - [x] Generate `uv.lock` file

# CLI Interface

- [x] Implement CLI wrapper
  - [x] Create `src/sleepstack/cli.py` with argument parsing
  - [x] Map CLI args to existing `main.py` function calls
  - [x] Preserve all existing command-line options
  - [x] Add help text and usage examples
- [x] Test CLI functionality
  - [x] Test `uv run sleepstack --help`
  - [x] Test basic generation: `uv run sleepstack --vibe calm -a campfire -m 5`
  - [x] Test all vibe presets work correctly
  - [x] Test custom ambience file option
  - [x] Test output path customization

# Asset Management

- [x] Reorganize audio assets
  - [x] Move `sounds/ambient/campfire/` → `assets/ambience/campfire/`
  - [x] Update code to reference new asset paths
  - [x] Create `build/binaural/` for generated binaural files
  - [x] Create `build/mix/` for mixed output files
- [x] Update path resolution
  - [x] Implement a `project_root()` resolver based on `Path(__file__).resolve().parents[...]`
  - [x] Use `pathlib.Path` everywhere for cross-platform compatibility
  - [x] Normalize user input with `Path(...).expanduser().resolve()`
  - [x] Build absolute paths to `assets/` and `build/` using that resolver (never rely on working dir)
  - [x] Modify `_repo_root()` functions to work with package structure
  - [x] Update `_sounds_dir()` to use `assets/` directory
  - [x] Ensure output directories are created automatically

# Testing & Validation

- [x] Test package installation
  - [x] Run `uv sync` to create `.venv` and install deps
  - [x] Test `uv run sleepstack` works from project root
  - [x] Test `uv tool install .` for global installation
  - [x] Verify `sleepstack` command works from anywhere after tool install
  - [x] uv run sleepstack --list-vibes
- [x] Unit tests (pytest):
  - [x] **Duration**: generated binaural length matches requested seconds ± 1 sample
  - [x] **Bit depth**: output WAV is 16-bit PCM (assert `sampwidth == 2`)
  - [x] **Stereo enforcement**: binaural must be 2-channel; ambience mono → duplicated to L/R
  - [x] **Mono ambience duplication**: assert L == R but not all zeros
  - [x] **Samplerate guard**: mismatch raises the expected error message
  - [x] **Clipping guard**: soft-limit engages; output peak < 0 dBFS
  - [x] **Vibe aliasing**: aliases (e.g., `sleep` → `deep`) resolve correctly
  - [x] **Mix length**: mixed output length equals binaural length exactly
- [x] Test fixtures and smoke tests:
  - [x] Add tiny fixture audio (1-second sine wav in `tests/fixtures/`)
  - [x] CLI smoke test: write file and verify stereo, samplerate=48000, dtype int16, length match
- [x] Validate functionality
  - [x] Generate test binaural with each vibe preset
  - [x] Test mixing with campfire ambience
  - [x] Verify output files are created in correct locations
  - [x] Test all command-line options and overrides
  - [x] Test on Windows path inputs
- [x] Test reproducibility
  - [x] Run `uv lock` to pin all dependencies
  - [x] Test `uv sync --frozen` for CI/CD compatibility
  - [x] Verify consistent behavior across runs
- [x] CI: GitHub Actions
  - [x] Setup uv; `uv sync --frozen`; run `pytest -q`; smoke-test `uv run sleepstack --help`
    - [x] Created `.github/workflows/ci.yml` with comprehensive testing
    - [x] Tests on Ubuntu and macOS with Python 3.11 and 3.12
    - [x] Includes dependency installation, tests, code quality, CLI smoke tests, and package building
  - [ ] Add Windows job once you care about Windows users

# Documentation & Cleanup

- [x] Update documentation
  - [x] Update `_docs/user-guide.md` with new CLI usage
    - [x] Updated all command examples to use `uv run sleepstack`
    - [x] Updated paths from `sounds/` to `assets/` and `build/`
    - [x] Added installation options and new CLI features
  - [x] Update `README.md`
    - [x] Copy-paste quick start with `uv run sleepstack --vibe calm -a campfire -m 5`
    - [x] Link to `_docs/user-guide.md` and `_docs/sleep-affirmation-primer.md`
    - [x] Added comprehensive examples and feature list
- [x] Add `CONTRIBUTING.md` with `uv` basics (optional)
  - [x] Document new project structure and development workflow
    - [x] Created comprehensive contributing guide with uv workflow
    - [x] Added development setup, testing, and code quality guidelines
- [x] Clean up old files
  - [x] Remove old standalone scripts from root directory
    - [x] Old scripts already deleted (moved to `src/sleepstack/`)
  - [x] Remove old `sounds/` directory if migration successful
    - [x] Old `sounds/` directory already deleted (moved to `assets/` and `build/`)
  - [x] Update any remaining references to old paths
    - [x] Fixed help text in `main.py` to reference `build/` instead of `sounds/`
    - [x] Verified all generated files go to `build/binaural/` and `build/mix/`
- [x] Final validation
  - [x] Run full test suite of all functionality
    - [x] All 21 tests passing
  - [x] Verify no regressions in audio quality or generation
    - [x] Tested CLI functionality: --help, --list-vibes, --version
    - [x] Tested core generation: 5-second calm track with campfire
    - [x] Verified global installation works
  - [x] Test edge cases and error handling
    - [x] Code formatted with black
    - [x] All functionality working correctly

# Notes

- **Project Context**: This is a binaural beats generator with ambient mixing capabilities. The current implementation uses standalone Python scripts that need to be restructured as a proper package.

- **Technical Constraints**: 
  - Must preserve all existing functionality (10 vibe presets, campfire ambience, mixing capabilities)
  - Audio files must remain at 48kHz sample rate for consistency
  - Outputs must be **16-bit PCM stereo**; samplerate **48 kHz**; enforce with tests
  - CLI should support all existing command-line options
  - If resampling is needed, implement via `soundfile` (or remove the dep)

- **Reference Materials**: 
  - Current working scripts: `main.py`, `make_binaural.py`, `mix_binaural_with_ambience.py`, `vibe_binaural.py`
  - Asset files in `sounds/ambient/campfire/` directory
  - Existing vibe presets and aliases in `main.py` and `vibe_binaural.py`

- **Conventions**: 
  - Use `uv` for all dependency management and project setup
  - Follow `src/` layout for package structure
  - Use `[project.scripts]` for CLI entry points
  - Keep assets outside the package in `assets/` directory
  - Use `build/` for generated outputs
  - Commit `pyproject.toml` and `uv.lock`, ignore `.venv`

## Example `pyproject.toml` snippet (safe pattern)

*(Use as a reference—don't override what `uv init --package` gives you; just fill in metadata, scripts, and tool configs.)*

```toml
[project]
name = "sleepstack"
version = "0.1.0"
description = "Binaural beats + ambience mixer for narration-ready sleep tracks"
readme = "README.md"
license = {text = "MIT"}
authors = [
    {name = "Your Name", email = "your.email@example.com"}
]
requires-python = ">=3.11"
dependencies = ["numpy"]  # add "soundfile" only if you use it

[project.optional-dependencies]
dev = ["pytest", "black", "mypy"]

[project.scripts]
sleepstack = "sleepstack.cli:main"

# Dev tool configs (add after uv adds dev deps)
[tool.black]
line-length = 100
target-version = ["py311"]

[tool.mypy]
python_version = "3.11"
strict = true
warn_unused_ignores = true
ignore_missing_imports = true

[tool.pytest.ini_options]
addopts = "-q"
pythonpath = ["src"]
```

## Standard CLI flags pattern (inside your parser)

* `--version`: prints package version from `importlib.metadata.version("sleepstack")`
* `--list-vibes`: dumps preset table and exits
* `--verbose/--quiet`: control logging level (use `logging`)
