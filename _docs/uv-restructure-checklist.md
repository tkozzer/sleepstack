---
title: UV Package Restructure Checklist
description: Migrate from standalone scripts to uv packaged application with proper src/ layout, build backend, and console scripts
---

This checklist follows `103-docs-checklist` — keep it updated as tasks complete. Reference real files using backticks.

# Dependencies

- Build-time
  - uv add -G dev pytest black mypy
- Runtime
  - uv add numpy
  - uv add soundfile (only if resampling is needed)
  - If replacing argparse with Click, add: uv add click

# Goal & KPIs

**Goal**: Restructure the project as a proper Python package using `uv`'s packaged application template with `src/` layout, build backend, and console scripts.

**Success Metrics**:
- [ ] `uv run sleepstack` works as a first-class CLI command
- [ ] `uv tool install .` works and `sleepstack` runs globally
- [ ] Build sdist/wheel succeeds (`uv build`)
- [ ] All existing functionality preserved (binaural generation, mixing, vibe presets)
- [ ] Clean `src/sleepstack/` package structure
- [ ] Proper `pyproject.toml` with `[project.scripts]` entry point
- [ ] Assets organized outside package (`assets/` and `build/` directories)
- [ ] Reproducible installs with `uv.lock`
- [ ] GitHub Actions CI passes on main (Linux + macOS)

# Project Structure Setup

- [ ] Create new packaged app skeleton
  - [ ] Run `uv init --package sleepstack` in clean directory
  - [ ] Verify generated structure: `pyproject.toml`, `src/sleepstack/__init__.py`
- [ ] Set up proper directory structure
  - [ ] Create `assets/ambience/campfire/` directory
  - [ ] Create `build/binaural/` and `build/mix/` directories
  - [ ] Move existing `sounds/` content to `assets/`
- [ ] Update `.gitignore`
  - [ ] Ignore `.venv/`, `build/`, `__pycache__/`, OS/editor junk
  - [ ] Include editor cruft: `.DS_Store`, `Thumbs.db`, and DAW caches (`*.band`, `*.logicx`, etc.)
  - [ ] **Commit** `pyproject.toml` and `uv.lock`

# Code Migration

- [ ] Move Python modules to `src/sleepstack/`
  - [ ] Move `main.py` → `src/sleepstack/main.py`
  - [ ] Move `make_binaural.py` → `src/sleepstack/make_binaural.py`
  - [ ] Move `mix_binaural_with_ambience.py` → `src/sleepstack/mix_binaural_with_ambience.py`
  - [ ] Move `vibe_binaural.py` → `src/sleepstack/vibe_binaural.py`
- [ ] Create a single orchestrator: `src/sleepstack/main.py` exports `run(argv: list[str] | None = None) -> int`
- [ ] Create CLI entry point
  - [ ] Create `src/sleepstack/cli.py` with `main()` function (only module touching argparse/Click)
  - [ ] `src/sleepstack/cli.py` parses args and calls `from .main import run; raise SystemExit(run())`
  - [ ] Add standard CLI flags: `--version`, `--list-vibes`, `--verbose/--quiet`
  - [ ] Decide exit codes: return `0` on success, non-zero on known errors
  - [ ] Add proper argument parsing and help text
- [ ] Update import paths
  - [ ] Fix relative imports between modules in `src/sleepstack/`
  - [ ] Update asset path references to use `assets/` instead of `sounds/`
  - [ ] Update output paths to use `build/` directories

# Package Configuration

- [ ] Configure `pyproject.toml`
  - [ ] Set project metadata (name, version, description, license, authors)
  - [ ] **Use the build backend generated by `uv init --package`** (do not override)
  - [ ] Add `[project.scripts]` entry: `sleepstack = "sleepstack.cli:main"`
  - [ ] Add runtime dependencies (`numpy` [and `soundfile` **only if used**])
  - [ ] Add `[project.optional-dependencies]` groups for `dev` (pytest/black/mypy)
  - [ ] Add dev dependency configs under `[tool.black]`, `[tool.mypy]`, `[tool.pytest.ini_options]`
- [ ] Add dependencies with uv
  - [ ] Run `uv add numpy` for runtime deps
  - [ ] Run `uv add soundfile` only if resampling is needed
  - [ ] Run `uv add -G dev pytest black mypy` for dev deps
  - [ ] Generate `uv.lock` file

# CLI Interface

- [ ] Implement CLI wrapper
  - [ ] Create `src/sleepstack/cli.py` with argument parsing
  - [ ] Map CLI args to existing `main.py` function calls
  - [ ] Preserve all existing command-line options
  - [ ] Add help text and usage examples
- [ ] Test CLI functionality
  - [ ] Test `uv run sleepstack --help`
  - [ ] Test basic generation: `uv run sleepstack --vibe calm -a campfire -m 5`
  - [ ] Test all vibe presets work correctly
  - [ ] Test custom ambience file option
  - [ ] Test output path customization

# Asset Management

- [ ] Reorganize audio assets
  - [ ] Move `sounds/ambient/campfire/` → `assets/ambience/campfire/`
  - [ ] Update code to reference new asset paths
  - [ ] Create `build/binaural/` for generated binaural files
  - [ ] Create `build/mix/` for mixed output files
- [ ] Update path resolution
  - [ ] Implement a `project_root()` resolver based on `Path(__file__).resolve().parents[...]`
  - [ ] Use `pathlib.Path` everywhere for cross-platform compatibility
  - [ ] Normalize user input with `Path(...).expanduser().resolve()`
  - [ ] Build absolute paths to `assets/` and `build/` using that resolver (never rely on working dir)
  - [ ] Modify `_repo_root()` functions to work with package structure
  - [ ] Update `_sounds_dir()` to use `assets/` directory
  - [ ] Ensure output directories are created automatically

# Testing & Validation

- [ ] Test package installation
  - [ ] Run `uv sync` to create `.venv` and install deps
  - [ ] Test `uv run sleepstack` works from project root
  - [ ] Test `uv tool install .` for global installation
  - [ ] Verify `sleepstack` command works from anywhere after tool install
  - [ ] uv run sleepstack --list-vibes
- [ ] Unit tests (pytest):
  - [ ] **Duration**: generated binaural length matches requested seconds ± 1 sample
  - [ ] **Bit depth**: output WAV is 16-bit PCM (assert `sampwidth == 2`)
  - [ ] **Stereo enforcement**: binaural must be 2-channel; ambience mono → duplicated to L/R
  - [ ] **Mono ambience duplication**: assert L == R but not all zeros
  - [ ] **Samplerate guard**: mismatch raises the expected error message
  - [ ] **Clipping guard**: soft-limit engages; output peak < 0 dBFS
  - [ ] **Vibe aliasing**: aliases (e.g., `sleep` → `deep`) resolve correctly
  - [ ] **Mix length**: mixed output length equals binaural length exactly
- [ ] Test fixtures and smoke tests:
  - [ ] Add tiny fixture audio (1-second sine wav in `tests/fixtures/`)
  - [ ] CLI smoke test: write file and verify stereo, samplerate=48000, dtype int16, length match
- [ ] Validate functionality
  - [ ] Generate test binaural with each vibe preset
  - [ ] Test mixing with campfire ambience
  - [ ] Verify output files are created in correct locations
  - [ ] Test all command-line options and overrides
  - [ ] Test on Windows path inputs
- [ ] Test reproducibility
  - [ ] Run `uv lock` to pin all dependencies
  - [ ] Test `uv sync --frozen` for CI/CD compatibility
  - [ ] Verify consistent behavior across runs
- [ ] CI: GitHub Actions
  - [ ] Setup uv; `uv sync --frozen`; run `pytest -q`; smoke-test `uv run sleepstack --help`
  - [ ] Add Windows job once you care about Windows users

# Documentation & Cleanup

- [ ] Update documentation
  - [ ] Update `_docs/user-guide.md` with new CLI usage
  - [ ] Update `README.md`
    - [ ] Copy-paste quick start with `uv run sleepstack --vibe calm -a campfire -m 5`
    - [ ] Link to `_docs/user-guide.md` and `_docs/sleep-affirmation-primer.md`
- [ ] Add `CONTRIBUTING.md` with `uv` basics (optional)
  - [ ] Document new project structure and development workflow
- [ ] Clean up old files
  - [ ] Remove old standalone scripts from root directory
  - [ ] Remove old `sounds/` directory if migration successful
  - [ ] Update any remaining references to old paths
- [ ] Final validation
  - [ ] Run full test suite of all functionality
  - [ ] Verify no regressions in audio quality or generation
  - [ ] Test edge cases and error handling

# Notes

- **Project Context**: This is a binaural beats generator with ambient mixing capabilities. The current implementation uses standalone Python scripts that need to be restructured as a proper package.

- **Technical Constraints**: 
  - Must preserve all existing functionality (10 vibe presets, campfire ambience, mixing capabilities)
  - Audio files must remain at 48kHz sample rate for consistency
  - Outputs must be **16-bit PCM stereo**; samplerate **48 kHz**; enforce with tests
  - CLI should support all existing command-line options
  - If resampling is needed, implement via `soundfile` (or remove the dep)

- **Reference Materials**: 
  - Current working scripts: `main.py`, `make_binaural.py`, `mix_binaural_with_ambience.py`, `vibe_binaural.py`
  - Asset files in `sounds/ambient/campfire/` directory
  - Existing vibe presets and aliases in `main.py` and `vibe_binaural.py`

- **Conventions**: 
  - Use `uv` for all dependency management and project setup
  - Follow `src/` layout for package structure
  - Use `[project.scripts]` for CLI entry points
  - Keep assets outside the package in `assets/` directory
  - Use `build/` for generated outputs
  - Commit `pyproject.toml` and `uv.lock`, ignore `.venv`

## Example `pyproject.toml` snippet (safe pattern)

*(Use as a reference—don't override what `uv init --package` gives you; just fill in metadata, scripts, and tool configs.)*

```toml
[project]
name = "sleepstack"
version = "0.1.0"
description = "Binaural beats + ambience mixer for narration-ready sleep tracks"
readme = "README.md"
license = {text = "MIT"}
authors = [
    {name = "Your Name", email = "your.email@example.com"}
]
requires-python = ">=3.11"
dependencies = ["numpy"]  # add "soundfile" only if you use it

[project.optional-dependencies]
dev = ["pytest", "black", "mypy"]

[project.scripts]
sleepstack = "sleepstack.cli:main"

# Dev tool configs (add after uv adds dev deps)
[tool.black]
line-length = 100
target-version = ["py311"]

[tool.mypy]
python_version = "3.11"
strict = true
warn_unused_ignores = true
ignore_missing_imports = true

[tool.pytest.ini_options]
addopts = "-q"
pythonpath = ["src"]
```

## Standard CLI flags pattern (inside your parser)

* `--version`: prints package version from `importlib.metadata.version("sleepstack")`
* `--list-vibes`: dumps preset table and exits
* `--verbose/--quiet`: control logging level (use `logging`)
